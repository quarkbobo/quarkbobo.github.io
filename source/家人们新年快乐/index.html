<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>/files</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui,-apple-system,Segoe UI,Roboto,
                   "PingFang SC","Microsoft YaHei",sans-serif;
      margin: 24px;
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .hint { opacity: .7; margin: 0 0 16px; line-height: 1.5; }
    .bar { display:flex; gap:10px; align-items:center; margin: 0 0 14px; }
    input[type="search"]{
      flex:1; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(127,127,127,.35); background: transparent;
      font-size: 14px;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid rgba(127,127,127,.25);
      border-radius: 12px;
      overflow: hidden;
    }
    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-top: 1px solid rgba(127,127,127,.15);
    }
    li:first-child { border-top: none; }
    .name {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .meta { opacity: .7; font-size: 12px; margin-left: 8px; }
    .actions { display: flex; gap: 8px; white-space: nowrap; }
    a.btn {
      text-decoration: none;
      padding: 6px 10px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 10px;
      font-size: 14px;
      user-select: none;
    }
    a.btn:hover { filter: brightness(1.05); }
    .empty { padding: 14px; opacity: .75; }
    .err { padding: 14px; color: #b00020; white-space: pre-wrap; }
    .small { font-size: 12px; opacity: .7; margin-top: 12px; line-height: 1.5; }
    code { padding: 2px 6px; border-radius: 8px; border: 1px solid rgba(127,127,127,.25); }
  </style>
</head>
<body>
<div class="wrap">
  <h1>/files</h1>
  <p class="hint">
    文件列表来自 GitHub API（读取仓库源码的 <code>/source/files</code>）。<br>
    “打开/下载”走站点真实路径 <code>/files/</code>（Hexo 发布后的目录），不受 NexT/PJAX 影响。
  </p>

  <div class="bar">
    <input id="q" type="search" placeholder="搜索文件名… (支持中文)" />
  </div>

  <ul id="list">
    <li class="empty">正在从 GitHub 读取文件列表…</li>
  </ul>

  <div id="small" class="small"></div>
</div>

<script>
/** =========================
 *  你的真实配置（已按你截图填好）
 *  ========================= */
const OWNER  = "quarkbobo";
const REPO   = "quarkbobo.github.io";
const BRANCH = "master";

/** 用于 GitHub API 列目录（源码路径） */
const DIR_FOR_API = "source/files";

/** 用于站点访问/下载（发布后的路径） */
const PUBLIC_PREFIX = "/files/";

/** =========================
 *  工具函数
 *  ========================= */
const listEl = document.getElementById("list");
const qEl = document.getElementById("q");
const smallEl = document.getElementById("small");

function fmtBytes(bytes){
  if (!Number.isFinite(bytes)) return "";
  const units = ["B","KB","MB","GB","TB"];
  let i = 0, n = bytes;
  while (n >= 1024 && i < units.length-1){ n /= 1024; i++; }
  return `${n.toFixed(i===0?0:1)} ${units[i]}`;
}

function safeText(s){
  return (s ?? "").toString();
}

/** 站点真实 URL：/files/<filename> */
function publicUrl(name){
  return PUBLIC_PREFIX + encodeURIComponent(name);
}

function render(items){
  const kw = (qEl.value || "").trim().toLowerCase();
  const filtered = !kw ? items : items.filter(it => it.name.toLowerCase().includes(kw));

  listEl.innerHTML = "";
  if (!filtered.length){
    listEl.innerHTML = `<li class="empty">没有匹配的文件</li>`;
    return;
  }

  for (const it of filtered){
    const name = safeText(it.name);
    const size = it.size ? fmtBytes(it.size) : "";

    const li = document.createElement("li");
    li.innerHTML = `
      <span class="name" title="${name}">
        ${name}<span class="meta">${size}</span>
      </span>
      <span class="actions">
        <a class="btn" href="javascript:void(0)" data-open="${name}">打开</a>
        <a class="btn" href="javascript:void(0)" data-dl="${name}">下载</a>
      </span>
    `;
    listEl.appendChild(li);
  }
}

/** GitHub Contents API：列出某个目录 */
async function loadFromGitHub(){
  // 注意：这里不要 encodeURIComponent 整个路径，否则 source/files 会变成 source%2Ffiles
  const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${DIR_FOR_API}?ref=${encodeURIComponent(BRANCH)}`;

  const res = await fetch(api, { headers: { "Accept": "application/vnd.github+json" } });
  if (!res.ok){
    const msg = await res.text().catch(() => "");
    throw new Error(`GitHub API 请求失败：HTTP ${res.status}\n${msg}`);
  }

  const data = await res.json();
  if (!Array.isArray(data)) throw new Error("返回不是目录列表。请检查 BRANCH/DIR_FOR_API 是否正确。");

  return data
    .filter(x => x && x.type === "file")
    .filter(x => (x.name || "").toLowerCase() !== "index.html")
    .map(x => ({ name: x.name, size: x.size || 0 }))
    .sort((a,b) => a.name.localeCompare(b.name, "zh-Hans-CN"));
}

/** 关键：用 JS 打开/下载，绕过 NexT/PJAX 拦截 */
document.addEventListener("click", (e) => {
  const a = e.target.closest("a");
  if (!a) return;

  const openName = a.getAttribute("data-open");
  const dlName = a.getAttribute("data-dl");
  if (!openName && !dlName) return;

  e.preventDefault();
  e.stopPropagation();

  const name = openName || dlName;
  const url = publicUrl(name);

  if (openName) {
    window.open(url, "_blank", "noopener");
  } else {
    const tmp = document.createElement("a");
    tmp.href = url;
    tmp.download = name;
    document.body.appendChild(tmp);
    tmp.click();
    tmp.remove();
  }
});

(async () => {
  try {
    const items = await loadFromGitHub();
    render(items);

    smallEl.innerHTML =
      `数据来源：GitHub API（<code>${OWNER}/${REPO}</code>，分支 <code>${BRANCH}</code>，目录 <code>/${DIR_FOR_API}</code>）。<br>` +
      `打开/下载：站点路径 <code>${PUBLIC_PREFIX}</code>。`;

    qEl.addEventListener("input", () => render(items));
  } catch (e){
    listEl.innerHTML = `<li class="err">${String(e.message || e)}</li>`;
    smallEl.innerHTML =
      `排查：1）确认仓库 <code>${OWNER}/${REPO}</code> 的 <code>${BRANCH}</code> 分支存在 <code>/${DIR_FOR_API}</code>；` +
      `2）确认站点上能直接访问 <code>${PUBLIC_PREFIX}文件名</code>；` +
      `3）仓库若为私有，GitHub API 无法匿名列出。`;
  }
})();
</script>
</body>
</html>
