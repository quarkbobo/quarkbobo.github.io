<div class="game-2048-container">
  <canvas id="game2048"></canvas>
  <div id="scoreDisplay" style="position:absolute;top:10px;left:50%;transform:translateX(-50%);color:#fff;font-size:24px;font-weight:bold;text-shadow:0 0 5px #000;">åˆ†æ•°: 0</div>
  <div id="highScoreDisplay" style="position:absolute;top:40px;left:50%;transform:translateX(-50%);color:#ff0;font-size:18px;font-weight:bold;text-shadow:0 0 5px #000;">æœ€é«˜åˆ†: 0</div>
  <div id="victoryMessage" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff0;font-size:36px;font-weight:bold;text-shadow:0 0 10px #000;display:none;">ğŸ‰ ä½ èµ¢äº†ï¼ ğŸ‰</div>
  <button id="resetBtn" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);padding:8px 16px;font-size:16px;border:none;border-radius:5px;background:#4CAF50;color:#fff;cursor:pointer;">é‡ç½®æ¸¸æˆ</button>
</div>

<style>
.game-2048-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  padding: 20px 0;
  box-sizing: border-box;
}

#game2048 {
  width: 100%;
  max-width: 500px;
  aspect-ratio: 1 / 1;
  background: #111;
  display: block;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
</style>

<script>
// åŸºç¡€è®¾ç½®
const canvas = document.getElementById('game2048');
const ctx = canvas.getContext('2d');
const scoreDisplay = document.getElementById('scoreDisplay');
const highScoreDisplay = document.getElementById('highScoreDisplay');
const victoryMessage = document.getElementById('victoryMessage');
const resetBtn = document.getElementById('resetBtn');

let grid = [];
const size = 4;
let cellSize, particleRadius;
let particles = [], flashes = [], ribbons = [];
let score = 0;
let highScore = 0;
const WIN_SCORE = 2048;

// ç²’å­ç±»
class Particle{
  constructor(x,y,color){
    this.x=x; this.y=y;
    this.vx=(Math.random()-0.5)*1.5;
    this.vy=(Math.random()-0.5)*1.5;
    this.color=color;
    this.alpha=1;
    this.radius=particleRadius;
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.alpha-=0.02;}
  draw(){ if(this.alpha<=0) return; ctx.save(); ctx.globalAlpha=this.alpha; ctx.fillStyle=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fill(); ctx.restore();}
}

// é—ªçƒåŠ¨ç”»
class Flash{
  constructor(x,y,size,color){ this.x=x; this.y=y; this.size=size; this.alpha=1; this.color=color;}
  update(){ this.alpha-=0.05;}
  draw(){ if(this.alpha<=0) return; ctx.save(); ctx.globalAlpha=this.alpha; ctx.fillStyle=this.color; ctx.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size); ctx.restore();}
}

// å½©å¸¦èƒŒæ™¯
class Ribbon{
  constructor(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.vx=Math.random()*1-0.5; this.vy=Math.random()*0.5+0.2; this.length=Math.random()*30+20; this.color=`hsl(${Math.random()*360},80%,60%)`;}
  update(){ this.x+=this.vx; this.y+=this.vy; if(this.y>canvas.height) this.y=0; if(this.x>canvas.width) this.x=0; if(this.x<0) this.x=canvas.width;}
  draw(){ ctx.strokeStyle=this.color; ctx.beginPath(); ctx.moveTo(this.x,this.y); ctx.lineTo(this.x,this.y-this.length); ctx.stroke();}
}

// åˆå§‹åŒ–æ ¼å­
function initGrid(){
  grid = Array(size).fill().map(()=>Array(size).fill(0));
  addRandom(); addRandom();
  resizeCanvas();
  ribbons=[]; for(let i=0;i<30;i++) ribbons.push(new Ribbon());
  score=0; updateScore(); victoryMessage.style.display='none';
}

// æ·»åŠ éšæœºæ•°å­—
function addRandom(){
  let empty=[]; for(let i=0;i<size;i++) for(let j=0;j<size;j++) if(grid[i][j]===0) empty.push([i,j]);
  if(empty.length===0) return;
  let [i,j]=empty[Math.floor(Math.random()*empty.length)];
  grid[i][j]=Math.random()<0.9?2:4;
  for(let k=0;k<10;k++) particles.push(new Particle(j*cellSize+cellSize/2,i*cellSize+cellSize/2,`hsl(${Math.random()*360},100%,50%)`));
}

// è‡ªé€‚åº” canvas
function resizeCanvas(){ const rect=canvas.getBoundingClientRect(); canvas.width=rect.width; canvas.height=rect.height; cellSize=canvas.width/size; particleRadius=cellSize/10;}

// ç»˜åˆ¶ç½‘æ ¼
function drawGrid(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ribbons.forEach(r=>{r.update(); r.draw();});
  for(let i=0;i<size;i++){ for(let j=0;j<size;j++){
    const val=grid[i][j];
    ctx.fillStyle=val===0?'#222':`hsl(${val*10%360},80%,50%)`;
    ctx.fillRect(j*cellSize+2,i*cellSize+2,cellSize-4,cellSize-4);
    if(val>0){ ctx.fillStyle='#fff'; ctx.font=`${cellSize/2}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(val,j*cellSize+cellSize/2,i*cellSize+cellSize/2);}
  }}
  particles.forEach((p,i)=>{p.update();p.draw();if(p.alpha<=0) particles.splice(i,1);});
  flashes.forEach((f,i)=>{f.update();f.draw();if(f.alpha<=0) flashes.splice(i,1);});
}

// æ›´æ–°åˆ†æ•°
function updateScore(){ scoreDisplay.textContent=`åˆ†æ•°: ${score}`; if(score>highScore){highScore=score; highScoreDisplay.textContent=`æœ€é«˜åˆ†: ${highScore}`;}}

// ç§»åŠ¨é€»è¾‘
function move(dir){
  let moved=false;
  for(let i=0;i<size;i++){
    let line=[];
    for(let j=0;j<size;j++){ let val=dir==='left'?grid[i][j]:dir==='right'?grid[i][size-1-j]:dir==='up'?grid[j][i]:grid[size-1-j][i]; if(val!==0) line.push(val);}
    for(let k=0;k<line.length-1;k++){ if(line[k]===line[k+1]){line[k]*=2; line.splice(k+1,1); flashes.push(new Flash((dir==='left'||dir==='right'?k:i)*cellSize+cellSize/2,(dir==='up'||dir==='down'?k:i)*cellSize+cellSize/2,cellSize,'#fff')); score+=line[k]; updateScore();}}
    while(line.length<size) line.push(0);
    for(let j=0;j<size;j++){ let val=dir==='left'?line[j]:dir==='right'?line[size-1-j]:dir==='up'?line[j]:line[size-1-j]; if(dir==='left'||dir==='right'){if(grid[i][j]!==val)moved=true;grid[i][j]=val;} else {if(grid[j][i]!==val)moved=true;grid[j][i]=val;}}
  }
  if(moved){addRandom(); drawGrid(); checkVictory();}
}

// æ£€æŸ¥èƒœåˆ©
function checkVictory(){ if(score>=WIN_SCORE) victoryMessage.style.display='block';}

// é”®ç›˜
document.addEventListener('keydown',e=>{
  switch(e.key){ case 'ArrowLeft': case 'a': move('left'); break; case 'ArrowRight': case 'd': move('right'); break; case 'ArrowUp': case 'w': move('up'); break; case 'ArrowDown': case 's': move('down'); break; }
});

// æ‰‹æœºæ»‘åŠ¨
let startX=0,startY=0;
canvas.addEventListener('touchstart',e=>{startX=e.touches[0].clientX; startY=e.touches[0].clientY;},{passive:true});
canvas.addEventListener('touchend',e=>{ let dx=e.changedTouches[0].clientX-startX; let dy=e.changedTouches[0].clientY-startY; if(Math.abs(dx)>Math.abs(dy)){if(dx>0) move('right'); else move('left');} else{if(dy>0) move('down'); else move('up');}},{passive:true});

// é‡ç½®æŒ‰é’®
resetBtn.addEventListener('click',()=>{initGrid();});

// è‡ªé€‚åº”
window.addEventListener('resize',resizeCanvas);

// åŠ¨ç”»å¾ªç¯
function loop(){drawGrid(); requestAnimationFrame(loop);}
initGrid(); loop();
</script>
