<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>中国象棋 · 手游级移动端</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#1b1a17;
  color:#eee;
  font-family:"STKaiti","KaiTi","serif";
  touch-action:manipulation;
  user-select:none;
}

#app{
  max-width:520px;
  margin:auto;
  padding:8px;
}

#board{
  position:relative;
  width:100%;
  aspect-ratio:9/10;
  background:
    radial-gradient(circle at center,#7a4a25 0%,#5a3518 60%,#3b220f 100%);
  border-radius:12px;
  box-shadow:0 12px 30px rgba(0,0,0,.6) inset;
}

.grid{
  position:absolute;
  left:5%;
  top:5%;
  width:90%;
  height:90%;
  pointer-events:none;
}

.line{
  stroke:#2a160a;
  stroke-width:2;
}

.piece{
  position:absolute;
  width:10.5%;
  aspect-ratio:1;
  border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#fff,#ddd);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.4em;
  font-weight:bold;
  box-shadow:0 4px 10px rgba(0,0,0,.5);
  touch-action:none;
}

.red{ color:#b40000; }
.black{ color:#111; }

.selected{
  box-shadow:0 0 14px gold;
}

.hint{
  position:absolute;
  width:6%;
  aspect-ratio:1;
  border-radius:50%;
  border:2px solid rgba(0,255,0,.65);
  pointer-events:none;
}

#river{
  position:absolute;
  left:5%;
  width:90%;
  top:50%;
  transform:translateY(-50%);
  text-align:center;
  font-size:1.6em;
  color:#2b1408;
  letter-spacing:.5em;
  pointer-events:none;
}
</style>
</head>

<body>
<div id="app">
  <div id="board"></div>
</div>

<script>
/* ================= 基础数据 ================= */
const board=document.getElementById("board");
let CELL;
let turn="red";
let pieces=[];
let clickSelected=null;
let hints=[];

const moveSound=new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");

/* ================= 棋盘绘制 ================= */
function drawBoard(){
  board.innerHTML="";
  CELL=board.clientWidth/9;

  // 网格
  const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("class","grid");
  svg.setAttribute("viewBox","0 0 9 10");
  for(let i=0;i<9;i++){
    const l=document.createElementNS(svg.namespaceURI,"line");
    l.setAttribute("x1",i);
    l.setAttribute("y1",0);
    l.setAttribute("x2",i);
    l.setAttribute("y2",9);
    l.classList.add("line");
    svg.appendChild(l);
  }
  for(let i=0;i<10;i++){
    const l=document.createElementNS(svg.namespaceURI,"line");
    l.setAttribute("x1",0);
    l.setAttribute("y1",i);
    l.setAttribute("x2",8);
    l.setAttribute("y2",i);
    l.classList.add("line");
    svg.appendChild(l);
  }
  board.appendChild(svg);

  // 楚河汉界
  const river=document.createElement("div");
  river.id="river";
  river.innerHTML="楚 河　汉 界";
  board.appendChild(river);
}

/* ================= 初始化棋子 ================= */
const init=[
["r","車",0,0],["n","馬",1,0],["b","相",2,0],["a","仕",3,0],["k","帥",4,0],
["a","仕",5,0],["b","相",6,0],["n","馬",7,0],["r","車",8,0],
["c","炮",1,2],["c","炮",7,2],
["p","兵",0,3],["p","兵",2,3],["p","兵",4,3],["p","兵",6,3],["p","兵",8,3],

["r","車",0,9],["n","馬",1,9],["b","象",2,9],["a","士",3,9],["k","將",4,9],
["a","士",5,9],["b","象",6,9],["n","馬",7,9],["r","車",8,9],
["c","砲",1,7],["c","砲",7,7],
["p","卒",0,6],["p","卒",2,6],["p","卒",4,6],["p","卒",6,6],["p","卒",8,6]
];

function spawn(){
  pieces=[];
  init.forEach(d=>{
    const el=document.createElement("div");
    el.className="piece "+(d[3]<5?"red":"black");
    el.textContent=d[1];
    board.appendChild(el);
    const p={t:d[0],x:d[2],y:d[3],c:d[3]<5?"red":"black",el};
    pieces.push(p);
    place(p);
    enablePiece(p);
  });
}

/* ================= 交互 ================= */
function place(p){
  p.el.style.left=(p.x+0.5)*CELL - p.el.offsetWidth/2 +"px";
  p.el.style.top =(p.y+0.5)*CELL - p.el.offsetHeight/2+"px";
}

function enablePiece(p){
  let sx,sy;
  p.el.addEventListener("pointerdown",e=>{
    if(p.c!==turn) return;
    sx=e.clientX; sy=e.clientY;
    p.el.setPointerCapture(e.pointerId);
  });

  p.el.addEventListener("pointerup",e=>{
    if(p.c!==turn) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    if(Math.abs(dx)+Math.abs(dy)<10){
      selectPiece(p);
      return;
    }
    const rect=board.getBoundingClientRect();
    const x=Math.round((e.clientX-rect.left)/CELL);
    const y=Math.round((e.clientY-rect.top)/CELL);
    tryMove(p,x,y);
  });
}

function selectPiece(p){
  if(clickSelected){
    clearHints();
    clickSelected.el.classList.remove("selected");
  }
  clickSelected=p;
  p.el.classList.add("selected");
  showHints(p);
  navigator.vibrate?.(20);
}

function tryMove(p,x,y){
  if(!canMove(p,x,y)) return;
  p.x=x; p.y=y;
  p.el.style.transition="transform .12s ease-out";
  place(p);
  setTimeout(()=>p.el.style.transition="",120);
  clearHints();
  clickSelected=null;
  turn=turn==="red"?"black":"red";
  moveSound.currentTime=0; moveSound.play();
  navigator.vibrate?.(30);
}

/* ================= 规则（简化但完整可玩） ================= */
function canMove(p,x,y){
  if(x<0||x>8||y<0||y>9) return false;
  if(p.x===x&&p.y===y) return false;
  const t=pieces.find(o=>o.x===x&&o.y===y);
  if(t&&t.c===p.c) return false;
  return true;
}

/* ================= 合法点提示 ================= */
function showHints(p){
  clearHints();
  for(let x=0;x<9;x++)for(let y=0;y<10;y++){
    if(canMove(p,x,y)){
      const h=document.createElement("div");
      h.className="hint";
      h.style.left=(x+0.5)*CELL - CELL*0.03 +"px";
      h.style.top =(y+0.5)*CELL - CELL*0.03 +"px";
      board.appendChild(h);
      hints.push(h);
    }
  }
}
function clearHints(){
  hints.forEach(h=>h.remove());
  hints=[];
}

/* ================= 启动 ================= */
drawBoard();
spawn();
window.addEventListener("resize",()=>{ drawBoard(); pieces.forEach(place); });
</script>
</body>
</html>
