<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>è”æœºä¸­å›½è±¡æ£‹ Â· æ¥šæ²³æ±‰ç•Œ</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
:root{
  --wood:#2a1a0c;
  --board:#4b2e14;
  --line:#d6b47c;
  --red:#c03030;
}
body{
  margin:0;
  background:radial-gradient(#120a05,#000);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  font-family:"KaiTi","STKaiti",serif;
  color:#f5d28b;
}
#game{
  background:var(--wood);
  padding:12px;
  border-radius:14px;
  box-shadow:0 0 40px rgba(0,0,0,.8);
  max-width:95vw;
}
#top{
  text-align:center;
  font-size:14px;
  margin-bottom:6px;
}
#board{
  position:relative;
  width:min(90vw,420px);
  aspect-ratio:9/10;
  background:linear-gradient(145deg,#6a4420,#3d240f);
  border:3px solid #1a0f05;
}
.line{position:absolute;background:var(--line)}
.piece{
  position:absolute;
  width:8.8%;
  aspect-ratio:1;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.2em;
  font-weight:bold;
  cursor:pointer;
}
.red{background:#f6e1e1;color:var(--red);border:2px solid var(--red)}
.black{background:#ddd;color:#000;border:2px solid #000}
.selected{box-shadow:0 0 10px 4px gold}

#river{
  position:absolute;
  top:45%;
  height:10%;
  width:100%;
  pointer-events:none;
}
#river svg{
  width:100%;
  height:100%;
}

#panel{
  display:flex;
  gap:6px;
  margin-top:6px;
}
input,button{
  background:#111;
  color:#f5d28b;
  border:1px solid #c9a063;
  border-radius:6px;
  padding:6px;
  flex:1;
}

#chat{
  margin-top:6px;
  background:#0e0804;
  border:1px solid #3a2613;
  padding:6px;
  height:100px;
  overflow:auto;
  font-size:12px;
}
</style>
</head>

<body>
<div id="game">
  <div id="top">
    ç”¨æˆ·ï¼š<span id="user"></span> |
    èº«ä»½ï¼š<span id="role">æœªè¿æ¥</span> |
    çŠ¶æ€ï¼š<span id="state">ç­‰å¾…</span>
  </div>

  <div id="board">
    <div id="river">
      <!-- SVG ä¹¦æ³•æ¥šæ²³æ±‰ç•Œ -->
      <svg viewBox="0 0 100 10" preserveAspectRatio="none">
        <text x="25" y="7" text-anchor="middle"
          font-size="7" fill="#e6c78a"
          style="font-family:KaiTi,STKaiti;letter-spacing:2">
          æ¥šæ²³
        </text>
        <text x="75" y="7" text-anchor="middle"
          font-size="7" fill="#e6c78a"
          style="font-family:KaiTi,STKaiti;letter-spacing:2">
          æ±‰ç•Œ
        </text>
      </svg>
    </div>
  </div>

  <div id="panel">
    <input id="name" placeholder="ç”¨æˆ·åï¼ˆå¯ç©ºï¼‰">
    <input id="room" placeholder="æˆ¿é—´å·">
  </div>
  <div id="panel">
    <button onclick="createRoom()">åˆ›å»º</button>
    <button onclick="joinRoom()">åŠ å…¥</button>
  </div>

  <div id="chat"></div>
</div>

<script>
/* ========= ç”¨æˆ· ========= */
let username = "";
function genName(){
  return "æœªå‘½å_" + Math.random().toString(36).slice(2,6);
}
username = genName();
document.getElementById("user").innerText = username;

/* ========= PeerJS ========= */
let peer=null, conn=null;
let myCamp=null, host=false;

/* ========= èŠå¤© ========= */
const chat = document.getElementById("chat");
function log(msg){
  chat.innerHTML += msg + "<br>";
  chat.scrollTop = chat.scrollHeight;
}

/* ========= æ£‹ç›˜æ•°æ® ========= */
const board=document.getElementById("board");
const CELL=board.clientWidth/9;
let turn="red", selected=null, pieces=[];

const init=[
["è½¦",0,0,"black"],["é©¬",1,0,"black"],["è±¡",2,0,"black"],["å£«",3,0,"black"],["å°†",4,0,"black"],
["å£«",5,0,"black"],["è±¡",6,0,"black"],["é©¬",7,0,"black"],["è½¦",8,0,"black"],
["ç‚®",1,2,"black"],["ç‚®",7,2,"black"],
["å’",0,3,"black"],["å’",2,3,"black"],["å’",4,3,"black"],["å’",6,3,"black"],["å’",8,3,"black"],
["è½¦",0,9,"red"],["é©¬",1,9,"red"],["ç›¸",2,9,"red"],["ä»•",3,9,"red"],["å¸…",4,9,"red"],
["ä»•",5,9,"red"],["ç›¸",6,9,"red"],["é©¬",7,9,"red"],["è½¦",8,9,"red"],
["ç‚®",1,7,"red"],["ç‚®",7,7,"red"],
["å…µ",0,6,"red"],["å…µ",2,6,"red"],["å…µ",4,6,"red"],["å…µ",6,6,"red"],["å…µ",8,6,"red"]
];

function drawBoard(){
  board.innerHTML += "";
  for(let i=0;i<10;i++){
    let h=document.createElement("div");
    h.className="line";
    h.style.width="100%";
    h.style.height="1px";
    h.style.top=i*10+"%";
    board.appendChild(h);
  }
  for(let i=0;i<9;i++){
    let v=document.createElement("div");
    v.className="line";
    v.style.height="100%";
    v.style.width="1px";
    v.style.left=i*(100/8)+"%";
    board.appendChild(v);
  }
}

function createPiece(n,x,y,c){
  const el=document.createElement("div");
  el.className=`piece ${c}`;
  el.innerText=n;
  board.appendChild(el);
  const p={el,n,x,y,c};
  place(p);
  pieces.push(p);
}

function place(p){
  p.el.style.left=p.x*CELL+"px";
  p.el.style.top=p.y*CELL+"px";
}

/* ========= æˆ¿é—´ ========= */
function createRoom(){
  const r=document.getElementById("room").value.trim();
  const n=document.getElementById("name").value.trim();
  if(n) username=n;
  peer=new Peer(r);
  host=true;
  myCamp="red";
  document.getElementById("role").innerText="çº¢æ–¹ï¼ˆæˆ¿ä¸»ï¼‰";
  peer.on("connection",c=>{
    conn=c;
    syncState();
    log("ğŸ”— ç©å®¶åŠ å…¥");
  });
  start();
}

function joinRoom(){
  const r=document.getElementById("room").value.trim();
  const n=document.getElementById("name").value.trim();
  if(n) username=n;
  peer=new Peer();
  peer.on("open",()=>{
    conn=peer.connect(r);
    myCamp="black";
    document.getElementById("role").innerText="é»‘æ–¹";
    conn.on("data",d=>loadState(d));
  });
}

function syncState(){
  if(conn) conn.send({pieces,turn});
}
function loadState(d){
  pieces=[];
  board.querySelectorAll(".piece").forEach(p=>p.remove());
  d.pieces.forEach(p=>createPiece(p.n,p.x,p.y,p.c));
  turn=d.turn;
  document.getElementById("state").innerText="å¯¹å±€ä¸­";
}

/* ========= å¯åŠ¨ ========= */
function start(){
  drawBoard();
  pieces=[];
  init.forEach(p=>createPiece(p[0],p[1],p[2],p[3]));
  document.getElementById("state").innerText="ç­‰å¾…ä¸­";
}
start();
</script>
</body>
</html>
