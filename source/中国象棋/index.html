<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è”æœºä¸­å›½è±¡æ£‹ Â· å›½èµ›é£</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
/* ===== å…¨å±€ ===== */
body{
  margin:0;
  background:#0b0704;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  font-family:"KaiTi","STKaiti","FangSong",serif;
  color:#f5d28b;
  user-select:none;
}

/* ===== ä¸»å®¹å™¨ ===== */
#app{
  background:#2a1a0c;
  padding:12px;
  border-radius:14px;
  box-shadow:0 0 40px rgba(0,0,0,.85);
  width:min(95vw,460px);
}

/* ===== é¡¶éƒ¨çŠ¶æ€ ===== */
#status{
  text-align:center;
  font-size:13px;
  margin-bottom:6px;
}

/* ===== æ£‹ç›˜ ===== */
#board{
  position:relative;
  width:100%;
  aspect-ratio:9/10;
  background:
    linear-gradient(135deg,#7a4a22,#3b220f),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.08'/%3E%3C/svg%3E");
  border:4px solid #1a0f05;
}

/* æ£‹çº¿ */
.line{
  position:absolute;
  background:#e0bf84;
}

/* æ¥šæ²³æ±‰ç•Œ */
#river{
  position:absolute;
  top:45%;
  height:10%;
  width:100%;
  pointer-events:none;
}
#river svg{
  width:100%;
  height:100%;
}

/* æ£‹å­ */
.piece{
  position:absolute;
  width:8.5%;
  aspect-ratio:1;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.25em;
  font-weight:bold;
  cursor:pointer;
  touch-action:none;
}
.red{
  background:#f7e4e4;
  color:#b02020;
  border:2px solid #b02020;
}
.black{
  background:#e0e0e0;
  color:#000;
  border:2px solid #000;
}
.sel{
  box-shadow:0 0 10px 4px gold;
}

/* ===== é¢æ¿ ===== */
#panel{
  display:flex;
  gap:6px;
  margin-top:6px;
}
input,button{
  flex:1;
  background:#120a05;
  color:#f5d28b;
  border:1px solid #c9a063;
  border-radius:6px;
  padding:6px;
}

/* ===== èŠå¤© ===== */
#chat{
  margin-top:6px;
  background:#0d0704;
  border:1px solid #3a2613;
  padding:6px;
  height:90px;
  overflow:auto;
  font-size:12px;
}
</style>
</head>

<body>
<div id="app">
  <div id="status">
    ç”¨æˆ·ï¼š<span id="user"></span> |
    èº«ä»½ï¼š<span id="role">æœªè¿æ¥</span> |
    å›åˆï¼š<span id="turn">çº¢</span>
  </div>

  <div id="board">
    <div id="river">
      <!-- SVG ä¹¦æ³•æ¥šæ²³æ±‰ç•Œ -->
      <svg viewBox="0 0 100 10" preserveAspectRatio="none">
        <text x="25" y="7" text-anchor="middle" font-size="7" fill="#e6c78a">æ¥šæ²³</text>
        <text x="75" y="7" text-anchor="middle" font-size="7" fill="#e6c78a">æ±‰ç•Œ</text>
      </svg>
    </div>
  </div>

  <div id="panel">
    <input id="name" placeholder="ç”¨æˆ·åï¼ˆå¯ç©ºï¼‰">
    <input id="room" placeholder="æˆ¿é—´å·">
  </div>
  <div id="panel">
    <button onclick="createRoom()">åˆ›å»º</button>
    <button onclick="joinRoom()">åŠ å…¥</button>
    <button onclick="copyRoom()">åˆ†äº«</button>
  </div>

  <div id="panel">
    <button onclick="requestUndo()">æ‚”æ£‹</button>
    <button onclick="exportRecord()">å¯¼å‡ºæ£‹è°±</button>
  </div>

  <div id="chat"></div>
</div>

<script>
/* =====================================================
   åŸºç¡€å·¥å…·
===================================================== */
const board = document.getElementById("board");
const chat  = document.getElementById("chat");
const CELL  = board.clientWidth / 9;

function log(t){
  chat.innerHTML += t + "<br>";
  chat.scrollTop = chat.scrollHeight;
}

function genName(){
  return "æœªå‘½å_" + Math.random().toString(36).slice(2,6);
}

function genRoom(){
  return "chess-" + Math.random().toString(36).slice(2,6);
}

/* =====================================================
   ç”¨æˆ· & Peer
===================================================== */
let username = genName();
document.getElementById("user").innerText = username;

let peer=null, conn=null;
let roomId="", myCamp="", turn="red";
let host=false;

/* =====================================================
   æ£‹ç›˜ & æ•°æ®
===================================================== */
let pieces=[], selected=null;
let history=[], record=[];
let checkCount = {red:0, black:0};

const init=[
["è½¦",0,0,"black"],["é©¬",1,0,"black"],["è±¡",2,0,"black"],["å£«",3,0,"black"],["å°†",4,0,"black"],
["å£«",5,0,"black"],["è±¡",6,0,"black"],["é©¬",7,0,"black"],["è½¦",8,0,"black"],
["ç‚®",1,2,"black"],["ç‚®",7,2,"black"],
["å’",0,3,"black"],["å’",2,3,"black"],["å’",4,3,"black"],["å’",6,3,"black"],["å’",8,3,"black"],

["è½¦",0,9,"red"],["é©¬",1,9,"red"],["ç›¸",2,9,"red"],["ä»•",3,9,"red"],["å¸…",4,9,"red"],
["ä»•",5,9,"red"],["ç›¸",6,9,"red"],["é©¬",7,9,"red"],["è½¦",8,9,"red"],
["ç‚®",1,7,"red"],["ç‚®",7,7,"red"],
["å…µ",0,6,"red"],["å…µ",2,6,"red"],["å…µ",4,6,"red"],["å…µ",6,6,"red"],["å…µ",8,6,"red"]
];

/* =====================================================
   ç»˜åˆ¶æ£‹ç›˜
===================================================== */
function drawBoard(){
  board.querySelectorAll(".line").forEach(l=>l.remove());
  for(let i=0;i<10;i++){
    let h=document.createElement("div");
    h.className="line";
    h.style.height="1px";
    h.style.width="100%";
    h.style.top=i*10+"%";
    board.appendChild(h);
  }
  for(let i=0;i<9;i++){
    let v=document.createElement("div");
    v.className="line";
    v.style.width="1px";
    v.style.height="100%";
    v.style.left=i*(100/8)+"%";
    board.appendChild(v);
  }
}

/* =====================================================
   æ£‹å­
===================================================== */
function createPiece(n,x,y,c){
  const el=document.createElement("div");
  el.className="piece "+c;
  el.innerText=n;
  board.appendChild(el);
  const p={n,x,y,c,el};
  place(p);
  bindPiece(p);
  pieces.push(p);
}

function place(p){
  p.el.style.left=p.x*CELL+"px";
  p.el.style.top =p.y*CELL+"px";
}

function bindPiece(p){
  let sx,sy;
  p.el.addEventListener("pointerdown",e=>{
    if(myCamp!==p.c || turn!==myCamp) return;
    selected=p;
    p.el.classList.add("sel");
    sx=e.clientX; sy=e.clientY;
    p.el.setPointerCapture(e.pointerId);
  });
  p.el.addEventListener("pointermove",e=>{
    if(selected!==p) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    p.el.style.transform=`translate(${dx}px,${dy}px)`;
  });
  p.el.addEventListener("pointerup",e=>{
    if(selected!==p) return;
    p.el.releasePointerCapture(e.pointerId);
    p.el.style.transform="";
    p.el.classList.remove("sel");

    const rect=board.getBoundingClientRect();
    const x=Math.round((e.clientX-rect.left)/CELL);
    const y=Math.round((e.clientY-rect.top)/CELL);

    tryMove(p,x,y);
    selected=null;
  });
}

/* =====================================================
   è§„åˆ™ï¼ˆæ ¸å¿ƒï¼‰
===================================================== */
function inBoard(x,y){ return x>=0&&x<9&&y>=0&&y<10; }

function pieceAt(x,y){
  return pieces.find(p=>p.x===x&&p.y===y);
}

function isEnemy(p,x,y){
  const t=pieceAt(x,y);
  return t && t.c!==p.c;
}

/* === å°†å†›æ£€æµ‹ === */
function isChecked(camp){
  const king = pieces.find(p=>p.c===camp && (p.n==="å°†"||p.n==="å¸…"));
  return pieces.some(p=>p.c!==camp && canMove(p,king.x,king.y,true));
}

/* === æ‰€æœ‰åˆæ³•æ­¥ === */
function getAllMoves(camp){
  let m=[];
  pieces.filter(p=>p.c===camp).forEach(p=>{
    for(let x=0;x<9;x++)for(let y=0;y<10;y++){
      if(canMove(p,x,y)){
        m.push({p, x, y});
      }
    }
  });
  return m;
}

/* === æ˜¯å¦å°†æ­» === */
function isCheckmate(camp){
  if(!isChecked(camp)) return false;
  return getAllMoves(camp).length===0;
}

/* === ç§»åŠ¨åˆæ³•æ€§ï¼ˆå«ç¦è‡ªæ€ï¼‰ === */
function canMove(p,x,y,ignoreSelfCheck){
  if(!inBoard(x,y)) return false;
  const t=pieceAt(x,y);
  if(t && t.c===p.c) return false;

  const dx=x-p.x, dy=y-p.y;
  let ok=false;

  switch(p.n){
    case "è½¦": ok = dx===0||dy===0; break;
    case "é©¬": ok = Math.abs(dx*dy)===2; break;
    case "ç‚®":
      let cnt=0;
      if(dx===0){
        for(let i=Math.min(p.y,y)+1;i<Math.max(p.y,y);i++)
          if(pieceAt(x,i))cnt++;
      }else if(dy===0){
        for(let i=Math.min(p.x,x)+1;i<Math.max(p.x,x);i++)
          if(pieceAt(i,y))cnt++;
      }else return false;
      ok = t ? cnt===1 : cnt===0;
      break;
    case "ç›¸":
    case "è±¡":
      ok=Math.abs(dx)===2&&Math.abs(dy)===2;
      if(p.c==="red"&&y<5) ok=false;
      if(p.c==="black"&&y>4) ok=false;
      break;
    case "ä»•":
    case "å£«":
      ok=Math.abs(dx)===1&&Math.abs(dy)===1;
      if(x<3||x>5) ok=false;
      if(p.c==="red"&&(y<7)) ok=false;
      if(p.c==="black"&&(y>2)) ok=false;
      break;
    case "å¸…":
    case "å°†":
      ok=Math.abs(dx)+Math.abs(dy)===1;
      if(x<3||x>5) ok=false;
      if(p.c==="red"&&(y<7)) ok=false;
      if(p.c==="black"&&(y>2)) ok=false;
      break;
    case "å…µ":
    case "å’":
      ok = (p.c==="red")
        ? (dy===-1 || (p.y<5 && Math.abs(dx)===1&&dy===0))
        : (dy===1  || (p.y>4 && Math.abs(dx)===1&&dy===0));
  }

  if(!ok) return false;

  if(!ignoreSelfCheck){
    const ox=p.x, oy=p.y;
    const cap=pieceAt(x,y);
    p.x=x; p.y=y;
    if(cap) pieces.splice(pieces.indexOf(cap),1);
    const selfCheck=isChecked(p.c);
    p.x=ox; p.y=oy;
    if(cap) pieces.push(cap);
    if(selfCheck) return false;
  }
  return true;
}

/* =====================================================
   èµ°å­
===================================================== */
function tryMove(p,x,y){
  if(!canMove(p,x,y)) return;

  history.push(JSON.stringify(pieces));
  const cap=pieceAt(x,y);
  if(cap){
    board.removeChild(cap.el);
    pieces.splice(pieces.indexOf(cap),1);
  }

  const fx=p.x, fy=p.y;
  p.x=x; p.y=y;
  place(p);

  record.push({p:p.n,from:[fx,fy],to:[x,y],turn});

  turn = turn==="red"?"black":"red";
  document.getElementById("turn").innerText = turn==="red"?"çº¢":"é»‘";

  if(isChecked(turn)){
    checkCount[turn]++;
    log("âš ï¸ å°†å†›ï¼");
    if(checkCount[turn]>=3){
      alert("é•¿å°†è¿è§„ï¼Œåˆ¤è´Ÿ");
    }
  }else{
    checkCount[turn]=0;
  }

  if(isCheckmate(turn)){
    alert("â™Ÿ å°†æ­»ï¼"+(turn==="red"?"é»‘":"çº¢")+"èƒœ");
  }

  if(conn) conn.send({type:"sync", pieces, turn});
}

/* =====================================================
   PeerJS
===================================================== */
function createRoom(){
  const n=document.getElementById("name").value.trim();
  if(n) username=n;
  document.getElementById("user").innerText=username;

  roomId=genRoom();
  document.getElementById("room").value=roomId;

  peer=new Peer(roomId);
  host=true;
  myCamp="red";
  document.getElementById("role").innerText="çº¢æ–¹";

  history.replaceState(null,"","?room="+roomId);

  peer.on("connection",c=>{
    conn=c;
    conn.on("data",onData);
    sync();
    log("ğŸ”— å¯¹æ‰‹åŠ å…¥");
  });
}

function joinRoom(){
  const r=document.getElementById("room").value.trim();
  if(!r) return;
  const n=document.getElementById("name").value.trim();
  if(n) username=n;
  document.getElementById("user").innerText=username;

  peer=new Peer();
  peer.on("open",()=>{
    conn=peer.connect(r);
    myCamp="black";
    document.getElementById("role").innerText="é»‘æ–¹";
    conn.on("data",onData);
  });
}

function onData(d){
  if(d.type==="sync"){
    load(d);
  }
}

function sync(){
  if(conn) conn.send({type:"sync", pieces, turn});
}

function load(d){
  pieces.forEach(p=>board.removeChild(p.el));
  pieces=[];
  d.pieces.forEach(p=>createPiece(p.n,p.x,p.y,p.c));
  turn=d.turn;
  document.getElementById("turn").innerText=turn==="red"?"çº¢":"é»‘";
}

/* =====================================================
   æ‚”æ£‹ / å¯¼å‡º
===================================================== */
function requestUndo(){
  if(history.length===0) return;
  const last=history.pop();
  load({pieces:JSON.parse(last),turn});
}

function exportRecord(){
  const blob=new Blob([JSON.stringify(record,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="chess_record.json";
  a.click();
}

/* =====================================================
   å¯åŠ¨
===================================================== */
drawBoard();
init.forEach(p=>createPiece(p[0],p[1],p[2],p[3]));

const auto=new URLSearchParams(location.search).get("room");
if(auto){
  document.getElementById("room").value=auto;
  log("ğŸ“Œ æˆ¿é—´å·å·²ä»é“¾æ¥è¯»å–");
}
</script>
</body>
</html>
