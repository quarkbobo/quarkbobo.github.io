const board = document.getElementById("board");

let CELL = 0;
const PADDING_RATIO = 0.06;

let pieces = [];
let history = [];

let peer, conn;
let roomId = null;
let username = null;

/* ================= 坐标系统 ================= */

function updateMetrics() {
  const size = board.clientWidth;
  CELL = size * (1 - PADDING_RATIO * 2) / 8;
}

function pos(x, y) {
  const pad = board.clientWidth * PADDING_RATIO;
  return {
    left: pad + x * CELL,
    top: pad + y * CELL
  };
}

window.addEventListener("resize", () => {
  updateMetrics();
  render();
});

/* ================= 初始化棋子 ================= */

function initPieces() {
  pieces = [
    { id: 1, text: "车", x: 0, y: 0 },
    { id: 2, text: "马", x: 1, y: 0 },
    { id: 3, text: "将", x: 4, y: 9 }
  ];
}

/* ================= 渲染 ================= */

function render() {
  board.innerHTML = "";
  pieces.forEach(p => {
    const el = document.createElement("div");
    el.className = "piece";
    el.textContent = p.text;

    const { left, top } = pos(p.x, p.y);
    const size = CELL * 0.8;

    el.style.width = el.style.height = size + "px";
    el.style.left = left - size / 2 + "px";
    el.style.top = top - size / 2 + "px";

    board.appendChild(el);
  });
}

/* ================= 联机 ================= */

function getUsername() {
  const input = document.getElementById("username").value.trim();
  return input || `未命名_${Math.floor(Math.random() * 10000)}`;
}

document.getElementById("create").onclick = () => {
  username = getUsername();
  peer = new Peer();
  peer.on("open", id => {
    roomId = id;
    document.getElementById("roomLabel").textContent = `房间号：${id}`;
  });

  peer.on("connection", c => {
    conn = c;
    bindConn();
  });
};

document.getElementById("join").onclick = () => {
  username = getUsername();
  const rid = document.getElementById("roomInput").value.trim();
  peer = new Peer();
  peer.on("open", () => {
    conn = peer.connect(rid);
    bindConn();
  });
};

function bindConn() {
  conn.on("open", () => {
    conn.send({ type: "sync", pieces, username });
  });

  conn.on("data", msg => {
    if (msg.type === "sync") {
      pieces = msg.pieces;
      render();
    }
    if (msg.type === "undo_request") {
      if (confirm("对方请求悔棋，是否同意？")) {
        undo();
        conn.send({ type: "undo_accept" });
      }
    }
    if (msg.type === "undo_accept") {
      undo();
    }
  });
}

/* ================= 悔棋 ================= */

function undo() {
  if (history.length === 0) return;
  pieces = history.pop();
  render();
}

document.getElementById("undo").onclick = () => {
  if (!conn) return alert("未联机");
  conn.send({ type: "undo_request" });
};

/* ================= 启动 ================= */

updateMetrics();
initPieces();
render();
